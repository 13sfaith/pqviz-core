import { WebSocketServer }  from 'ws';

let wss: WebSocketServer | null = null;

const message: string = `[{"name":"1","calls":"2"},"test/chalk.js",["3","4","5","6","7","8"],{"name":"9","calls":"10","parent":"0"},{"name":"11","calls":"12","parent":"0"},{"name":"13","calls":"14","parent":"0"},{"name":"13","calls":"15","parent":"0"},{"name":"16","calls":"17","parent":"0"},{"name":"18","calls":"19","parent":"0"},"source/index.js",["20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39"],"test",[],"chalk",["40"],["41"],"chalk.bold",["42","43","44","45"],"chalk.green",["46","47","48","49"],{"name":"50","calls":"51","parent":"3"},{"name":"52","calls":"53","parent":"3"},{"name":"54","calls":"55","parent":"3"},{"name":"50","calls":"56","parent":"3"},{"name":"57","calls":"58","parent":"3"},{"name":"57","calls":"59","parent":"3"},{"name":"57","calls":"60","parent":"3"},{"name":"61","calls":"62","parent":"3"},{"name":"63","calls":"64","parent":"3"},{"name":"65","calls":"66","parent":"3"},{"name":"67","calls":"68","parent":"3"},{"name":"69","calls":"70","parent":"3"},{"name":"67","calls":"71","parent":"3"},{"name":"69","calls":"72","parent":"3"},{"name":"67","calls":"73","parent":"3"},{"name":"69","calls":"74","parent":"3"},{"name":"75","calls":"76","parent":"3"},{"name":"75","calls":"77","parent":"3"},{"name":"78","calls":"79","parent":"3"},{"name":"78","calls":"80","parent":"3"},{"name":"81","calls":"82","parent":"5"},{"name":"81","calls":"83","parent":"6"},{"name":"84","calls":"85","parent":"7"},{"name":"86","calls":"87","parent":"7"},{"name":"88","calls":"89","parent":"7"},{"name":"90","calls":"91","parent":"7"},{"name":"84","calls":"92","parent":"8"},{"name":"86","calls":"93","parent":"8"},{"name":"88","calls":"94","parent":"8"},{"name":"90","calls":"95","parent":"8"},"source/vendor/ansi-styles/index.js",["96","97","98","99"],"source/vendor/supports-color/index.js",["100","101","102","103","104","105","106","107","108","109","110","111"],"source/utilities.js",[],[],"Symbol",[],[],[],"Object.create",[],"Object.setPrototypeOf",[],"Object.entries",[],"undefined.toUpperCase",[],"model.slice",[],[],[],[],[],"Object.defineProperties",[],[],"createChalk",["112"],["113"],"strings.join",[],[],"createStyler",[],"createBuilder",["114"],"Object.defineProperty",[],"builder",["115"],[],["116"],[],["117"],{"name":"118","calls":"119","parent":"20"},{"name":"118","calls":"120","parent":"20"},{"name":"118","calls":"121","parent":"20"},{"name":"122","calls":"123","parent":"20"},{"name":"124","calls":"125","parent":"21"},{"name":"124","calls":"126","parent":"21"},{"name":"124","calls":"127","parent":"21"},{"name":"124","calls":"128","parent":"21"},{"name":"124","calls":"129","parent":"21"},{"name":"124","calls":"130","parent":"21"},{"name":"124","calls":"131","parent":"21"},{"name":"124","calls":"132","parent":"21"},{"name":"133","calls":"134","parent":"21"},{"name":"135","calls":"136","parent":"21"},{"name":"133","calls":"137","parent":"21"},{"name":"135","calls":"138","parent":"21"},{"name":"139","calls":"140","parent":"38"},{"name":"139","calls":"141","parent":"39"},{"name":"63","calls":"142","parent":"43"},{"name":"143","calls":"144","parent":"45"},{"name":"63","calls":"145","parent":"47"},{"name":"143","calls":"146","parent":"49"},"Object.keys",[],[],[],"assembleStyles",["147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206"],"hasFlag",["207","208","209"],["210","211","212"],["213","214","215"],["216","217","218"],["219","220","221"],["222","223","224"],["225","226","227"],["228","229","230"],"createSupportsColor",["231","232","233","234"],"tty.isatty",[],[],[],"chalkFactory",["235","236"],["237","238"],[],"applyStyle",["239","240"],[],["241","242"],{"name":"65","calls":"243","parent":"99"},{"name":"65","calls":"244","parent":"99"},{"name":"245","calls":"246","parent":"99"},{"name":"245","calls":"247","parent":"99"},{"name":"245","calls":"248","parent":"99"},{"name":"245","calls":"249","parent":"99"},{"name":"245","calls":"250","parent":"99"},{"name":"245","calls":"251","parent":"99"},{"name":"245","calls":"252","parent":"99"},{"name":"245","calls":"253","parent":"99"},{"name":"245","calls":"254","parent":"99"},{"name":"88","calls":"255","parent":"99"},{"name":"65","calls":"256","parent":"99"},{"name":"245","calls":"257","parent":"99"},{"name":"245","calls":"258","parent":"99"},{"name":"245","calls":"259","parent":"99"},{"name":"245","calls":"260","parent":"99"},{"name":"245","calls":"261","parent":"99"},{"name":"245","calls":"262","parent":"99"},{"name":"245","calls":"263","parent":"99"},{"name":"245","calls":"264","parent":"99"},{"name":"245","calls":"265","parent":"99"},{"name":"245","calls":"266","parent":"99"},{"name":"245","calls":"267","parent":"99"},{"name":"245","calls":"268","parent":"99"},{"name":"245","calls":"269","parent":"99"},{"name":"245","calls":"270","parent":"99"},{"name":"245","calls":"271","parent":"99"},{"name":"245","calls":"272","parent":"99"},{"name":"245","calls":"273","parent":"99"},{"name":"245","calls":"274","parent":"99"},{"name":"88","calls":"275","parent":"99"},{"name":"65","calls":"276","parent":"99"},{"name":"245","calls":"277","parent":"99"},{"name":"245","calls":"278","parent":"99"},{"name":"245","calls":"279","parent":"99"},{"name":"245","calls":"280","parent":"99"},{"name":"245","calls":"281","parent":"99"},{"name":"245","calls":"282","parent":"99"},{"name":"245","calls":"283","parent":"99"},{"name":"245","calls":"284","parent":"99"},{"name":"245","calls":"285","parent":"99"},{"name":"245","calls":"286","parent":"99"},{"name":"245","calls":"287","parent":"99"},{"name":"245","calls":"288","parent":"99"},{"name":"245","calls":"289","parent":"99"},{"name":"245","calls":"290","parent":"99"},{"name":"245","calls":"291","parent":"99"},{"name":"245","calls":"292","parent":"99"},{"name":"245","calls":"293","parent":"99"},{"name":"245","calls":"294","parent":"99"},{"name":"88","calls":"295","parent":"99"},{"name":"88","calls":"296","parent":"99"},{"name":"297","calls":"298","parent":"99"},{"name":"299","calls":"300","parent":"99"},{"name":"301","calls":"302","parent":"99"},{"name":"297","calls":"303","parent":"99"},{"name":"299","calls":"304","parent":"99"},{"name":"301","calls":"305","parent":"99"},{"name":"75","calls":"306","parent":"99"},{"name":"307","calls":"308","parent":"100"},{"name":"309","calls":"310","parent":"100"},{"name":"309","calls":"311","parent":"100"},{"name":"307","calls":"312","parent":"101"},{"name":"309","calls":"313","parent":"101"},{"name":"309","calls":"314","parent":"101"},{"name":"307","calls":"315","parent":"102"},{"name":"309","calls":"316","parent":"102"},{"name":"309","calls":"317","parent":"102"},{"name":"307","calls":"318","parent":"103"},{"name":"309","calls":"319","parent":"103"},{"name":"309","calls":"320","parent":"103"},{"name":"307","calls":"321","parent":"104"},{"name":"309","calls":"322","parent":"104"},{"name":"309","calls":"323","parent":"104"},{"name":"307","calls":"324","parent":"105"},{"name":"309","calls":"325","parent":"105"},{"name":"309","calls":"326","parent":"105"},{"name":"307","calls":"327","parent":"106"},{"name":"309","calls":"328","parent":"106"},{"name":"309","calls":"329","parent":"106"},{"name":"307","calls":"330","parent":"107"},{"name":"309","calls":"331","parent":"107"},{"name":"309","calls":"332","parent":"107"},{"name":"333","calls":"334","parent":"108"},{"name":"335","calls":"336","parent":"108"},{"name":"333","calls":"337","parent":"108"},{"name":"335","calls":"338","parent":"108"},{"name":"339","calls":"340","parent":"112"},{"name":"63","calls":"341","parent":"112"},{"name":"339","calls":"342","parent":"113"},{"name":"63","calls":"343","parent":"113"},{"name":"344","calls":"345","parent":"115"},{"name":"346","calls":"347","parent":"115"},{"name":"344","calls":"348","parent":"117"},{"name":"346","calls":"349","parent":"117"},[],[],"codes.set",[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],"wrapAnsi16",[],"wrapAnsi256",[],"wrapAnsi16m",[],[],[],[],[],"flag.startsWith",[],"argv.indexOf",[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],"_supportsColor",["350","351","352","353","354"],"translateLevel",[],["355","356","357","358","359"],[],"applyOptions",[],[],[],[],"string.includes",[],"string.indexOf",[],[],[],{"name":"360","calls":"361","parent":"231"},{"name":"124","calls":"362","parent":"231"},{"name":"124","calls":"363","parent":"231"},{"name":"124","calls":"364","parent":"231"},{"name":"124","calls":"365","parent":"231"},{"name":"360","calls":"366","parent":"233"},{"name":"124","calls":"367","parent":"233"},{"name":"124","calls":"368","parent":"233"},{"name":"124","calls":"369","parent":"233"},{"name":"124","calls":"370","parent":"233"},"envForceColor",[],["371","372","373"],["374","375","376"],["377","378","379"],["380","381","382"],[],["383","384","385"],["386","387","388"],["389","390","391"],["392","393","394"],{"name":"307","calls":"395","parent":"351"},{"name":"309","calls":"396","parent":"351"},{"name":"309","calls":"397","parent":"351"},{"name":"307","calls":"398","parent":"352"},{"name":"309","calls":"399","parent":"352"},{"name":"309","calls":"400","parent":"352"},{"name":"307","calls":"401","parent":"353"},{"name":"309","calls":"402","parent":"353"},{"name":"309","calls":"403","parent":"353"},{"name":"307","calls":"404","parent":"354"},{"name":"309","calls":"405","parent":"354"},{"name":"309","calls":"406","parent":"354"},{"name":"307","calls":"407","parent":"356"},{"name":"309","calls":"408","parent":"356"},{"name":"309","calls":"409","parent":"356"},{"name":"307","calls":"410","parent":"357"},{"name":"309","calls":"411","parent":"357"},{"name":"309","calls":"412","parent":"357"},{"name":"307","calls":"413","parent":"358"},{"name":"309","calls":"414","parent":"358"},{"name":"309","calls":"415","parent":"358"},{"name":"307","calls":"416","parent":"359"},{"name":"309","calls":"417","parent":"359"},{"name":"309","calls":"418","parent":"359"},[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]]`

export function startWebSocketServer(port = 8080): void {
  wss = new WebSocketServer({ port });

  wss.on('connection', (ws) => {
    console.log('WebSocket client connected');

    ws.send(JSON.stringify({ type: 'trace', message: message }));
  });

  console.log(`WebSocket server listening on ws://localhost:${port}`);
}

export function broadcast(message: any): void {
  if (!wss) return;

  const data = typeof message === 'string' ? message : JSON.stringify(message);

  wss.clients.forEach((client) => {
    if (client.readyState === WebSocket.OPEN) {
      client.send(data);
    }
  });
}
